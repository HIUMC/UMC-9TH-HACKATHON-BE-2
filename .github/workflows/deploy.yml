name: Deploy to EC2

on:
  push:

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. 코드 가져오기
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # 2. JDK 17 세팅
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Gradle 권한 부여 및 빌드 (테스트 제외 - 시간 단축용)
      - name: Build with Gradle
        run: |
          chmod +x ./gradlew
          ./gradlew clean bootJar -x test

      # 4. 빌드된 Jar 파일을 EC2로 전송 (SCP)
      - name: Copy Jar to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_KEY }}
          source: "./build/libs/*.jar"
          target: "/home/ubuntu/app"
          strip_components: 2 # build/libs 경로 제거하고 jar만 옮김

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
            host: ${{ secrets.EC2_HOST }}       # EC2 퍼블릭 IP
            username: ${{ secrets.EC2_USERNAME }} # 보통 'ubuntu' 또는 'ec2-user'
            key: ${{ secrets.EC2_KEY }}     # pem 키 내용 전체
            port: 22
            script: |
              # 1. 실행 중인 Spring Boot 프로세스 종료 (있을 경우에만)
              # 'your-project-name' 부분을 실제 jar 파일 이름이나 프로젝트명으로 바꾸세요.
              PID=$(pgrep -f your-project-name)
              if [ -n "$PID" ]; then
                echo "Killing existing process: $PID"
                kill -15 $PID
                sleep 10 # 종료될 때까지 잠시 대기
              fi
              
              # 2. 새 버전 배포 및 실행
              echo "Starting new application..."
              # nohup: 터미널이 끊겨도 실행 유지
              # 2>&1 &: 에러 로그도 함께 저장하고 백그라운드 실행
              nohup java -jar build/libs/your-project-name.jar > app.log 2>&1 &